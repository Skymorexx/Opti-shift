{% extends "layout.html" %}

{% block title %}Opti-shift | Personel{% endblock %}

{% block page_header %}
  <div class="opt-page-header">
    <div>
      <span class="opt-page-eyebrow">Ekip Yonetimi</span>
      <h1 class="opt-page-title">Personel Paneli</h1>
      <p class="opt-page-subtitle">
        Klinik ekibinizi guncel tutun, gorev sinirlarini ve kidem kurallarini yonetin.
      </p>
    </div>
    <div class="opt-page-actions">
      <span class="opt-page-meta">Toplam personel: {{ staff|length }}</span>
    </div>
  </div>
{% endblock %}

{% block content %}
  <section class="opt-surface-card">
    <header class="opt-toolbar">
      <h2 class="opt-toolbar-title">Yeni Personel Ekle</h2>
    </header>
    {% if error %}
      <div class="alert alert-danger opt-alert" role="alert">{{ error }}</div>
    {% endif %}
    <form method="post" action="{{ url_for('personel') }}" class="opt-form-grid opt-form-grid--cols-2">
      <input type="hidden" name="action" value="add">
      <div>
        <label class="form-label" for="name">Ad Soyad</label>
        <input type="text" id="name" name="name" class="form-control" placeholder="Orn: Dr. Ahmet Vural" required>
      </div>
      <div>
        <label class="form-label" for="title">Unvan</label>
        <select id="title" name="title" class="form-select" required>
          {% for option in title_options %}
            <option value="{{ option }}">{{ option }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="seniority-group" style="display: none;">
        <label class="form-label" for="seniority">Kidem</label>
        <select id="seniority" name="seniority" class="form-select">
          <option value="">Kidem secin</option>
          {% for value, label in seniority_options %}
            <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="night-limits" class="opt-form-grid opt-form-grid--cols-2" style="display: none;">
        <div>
          <label class="form-label" for="min_night">Minimum Aylik Nobet</label>
          <input type="number" id="min_night" name="min_night" min="0" class="form-control" placeholder="Orn: 2">
        </div>
        <div>
          <label class="form-label" for="max_night">Maksimum Aylik Nobet</label>
          <input type="number" id="max_night" name="max_night" min="0" class="form-control" placeholder="Orn: 6">
        </div>
      </div>
      <div class="opt-form-grid__full">
        <div class="opt-floating-actions">
          <button type="submit" class="btn btn-primary btn-lg">Personel Ekle</button>
        </div>
      </div>
    </form>
  </section>

  <section class="opt-surface-card">
    <header class="opt-toolbar">
      <h2 class="opt-toolbar-title">Personel Listesi</h2>
      {% if staff %}
        <span class="opt-meta">{{ staff|length }} kayit goruntuleniyor</span>
      {% endif %}
    </header>
    {% if staff %}
      <div class="opt-table-wrapper">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Ad Soyad</th>
              <th scope="col">Unvan</th>
              <th scope="col">Kidem</th>
              <th scope="col">Min Nobet</th>
              <th scope="col">Max Nobet</th>
              <th scope="col">Islemler</th>
            </tr>
          </thead>
          <tbody>
            {% for person in staff %}
              {% set seniority_value = person['seniority'] %}
              <tr>
                <td>{{ person['id'] }}</td>
                <td><strong>{{ person['name'] }}</strong></td>
                <td>{{ person['title'] }}</td>
                <td>{{ seniority_labels.get(seniority_value, '-') if seniority_value else '-' }}</td>
                <td>{{ person["min_night_duties_per_month"] if person["min_night_duties_per_month"] is not none else '-' }}</td>
                <td>{{ person["max_night_duties_per_month"] if person["max_night_duties_per_month"] is not none else '-' }}</td>
                <td>
                  <div class="opt-table-actions">
                    {% if person["title"] == "Asst. Dr." %}
                      <form method="post" action="{{ url_for('personel') }}" class="opt-table-actions__form">
                        <input type="hidden" name="action" value="update">
                        <input type="hidden" name="staff_id" value="{{ person['id'] }}">
                        <select name="seniority" class="form-select form-select-sm" aria-label="Kidem secin">
                          {% for value, label in seniority_options %}
                            <option value="{{ value }}" {% if person['seniority'] == value %}selected{% endif %}>{{ label }}</option>
                          {% endfor %}
                        </select>
                        <select name="min_night" class="form-select form-select-sm" aria-label="Minimum nobet">
                          <option value="" {% if person['min_night_duties_per_month'] is none %}selected{% endif %}>Min yok</option>
                          {% for value in night_limit_options %}
                            <option value="{{ value }}" {% if person['min_night_duties_per_month'] == value %}selected{% endif %}>{{ value }}</option>
                          {% endfor %}
                        </select>
                        <select name="max_night" class="form-select form-select-sm" aria-label="Maksimum nobet">
                          <option value="" {% if person['max_night_duties_per_month'] is none %}selected{% endif %}>Max yok</option>
                          {% for value in night_limit_options %}
                            <option value="{{ value }}" {% if person['max_night_duties_per_month'] == value %}selected{% endif %}>{{ value }}</option>
                          {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-outline-primary btn-sm">Kaydet</button>
                      </form>
                    {% endif %}
                    <form method="post" action="{{ url_for('personel') }}">
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="staff_id" value="{{ person['id'] }}">
                      <button type="submit" class="btn btn-outline-danger btn-sm">Sil</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="opt-empty-state">
        <p>Henuz kayitli personel bulunmuyor. Once ekip arkadaslarinizi ekleyin.</p>
      </div>
    {% endif %}
  </section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function() {
      var titleSelect = document.getElementById('title');
      var seniorityGroup = document.getElementById('seniority-group');
      var senioritySelect = document.getElementById('seniority');
      var nightLimits = document.getElementById('night-limits');
      var minNightInput = document.getElementById('min_night');
      var maxNightInput = document.getElementById('max_night');

      function syncSeniority() {
        var needsSeniority = titleSelect.value === 'Asst. Dr.';
        seniorityGroup.style.display = needsSeniority ? 'block' : 'none';
        senioritySelect.disabled = !needsSeniority;
        nightLimits.style.display = needsSeniority ? 'grid' : 'none';
        minNightInput.disabled = !needsSeniority;
        maxNightInput.disabled = !needsSeniority;
        if (!needsSeniority) {
          senioritySelect.value = '';
          minNightInput.value = '';
          maxNightInput.value = '';
        }
      }

      titleSelect.addEventListener('change', syncSeniority);
      syncSeniority();
    })();
  </script>
{% endblock %}
