{% extends "layout.html" %}

{% block title %}{{ t('Opti-Shift | Personel') }}{% endblock %}

{% block page_header %}
  <div class="opt-page-header">
    <div>
      <span class="opt-page-eyebrow">{{ t('Ekip Yönetimi') }}</span>
      <h1 class="opt-page-title">{{ t('Personel Paneli') }}</h1>
      <p class="opt-page-subtitle">
        {{ t('Klinik ekibinizi güncel tutun, görev sınırlarını ve kıdem kurallarını yönetin.') }}
      </p>
    </div>
    <div class="opt-page-actions">
      <span class="opt-page-meta">{{ t('Toplam personel: {count}', count=staff|length) }}</span>
    </div>
  </div>
{% endblock %}

{% block content %}
  <section class="opt-surface-card">
    <header class="opt-toolbar">
      <h2 class="opt-toolbar-title">{{ t('Yeni Personel Ekle') }}</h2>
    </header>
    {% if error %}
      <div class="alert alert-danger opt-alert" role="alert">{{ error }}</div>
    {% endif %}
    <form method="post" action="{{ url_for('personel') }}" class="opt-form-grid opt-form-grid--cols-2">
      <input type="hidden" name="action" value="add">
      <div>
        <label class="form-label" for="name">{{ t('Ad Soyad') }}</label>
        <input type="text" id="name" name="name" class="form-control" placeholder="{{ t('Örn: Dr. Ahmet Vural') }}" required>
      </div>
      <div>
        <label class="form-label" for="title">{{ t('Ünvan') }}</label>
        <select id="title" name="title" class="form-select" required>
          {% for option in title_options %}
            <option value="{{ option }}">{{ t(option) }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="seniority-group" style="display: none;">
        <label class="form-label" for="seniority">{{ t('Kıdem') }}</label>
        <select id="seniority" name="seniority" class="form-select">
          <option value="">{{ t('Kıdem seçin') }}</option>
          {% for value, label in seniority_options %}
            <option value="{{ value }}">{{ t(label) }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="education-year-group" style="display: none;">
        <label class="form-label" for="education_year">{{ t('Eğitim Yılı') }}</label>
        <select id="education_year" name="education_year" class="form-select">
          <option value="">{{ t('Eğitim yılı seçin') }}</option>
          {% for value, label in education_year_options %}
            <option value="{{ value }}">{{ t(label) }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="night-exempt-row" class="form-check form-switch opt-form-switch" style="display: none;">
        <input class="form-check-input" type="checkbox" id="night_duty_exempt" name="night_duty_exempt" value="1">
        <label class="form-check-label" for="night_duty_exempt">{{ t('Gece Nöbetinden Muaf') }}</label>
      </div>
      <div id="night-limits" class="opt-form-grid opt-form-grid--cols-2" style="display: none;">
        <div>
          <label class="form-label" for="min_night">{{ t('Minimum Aylık Nöbet') }}</label>
          <input type="number" id="min_night" name="min_night" min="0" class="form-control" placeholder="{{ t('Örn: 2') }}">
        </div>
        <div>
          <label class="form-label" for="max_night">{{ t('Maksimum Aylık Nöbet') }}</label>
          <input type="number" id="max_night" name="max_night" min="0" class="form-control" placeholder="{{ t('Örn: 6') }}">
        </div>
      </div>
      <div class="opt-form-grid__full">
        <div class="opt-floating-actions">
          <button type="submit" class="btn btn-primary btn-lg">{{ t('Personel Ekle') }}</button>
        </div>
      </div>
    </form>
  </section>

  <section class="opt-surface-card">
    <header class="opt-toolbar">
      <h2 class="opt-toolbar-title">{{ t('Personel Listesi') }}</h2>
      {% if staff %}
        <span class="opt-meta">{{ t('{count} kayıt görüntüleniyor', count=staff|length) }}</span>
      {% endif %}
    </header>
    {% if staff %}
      <div class="opt-table-wrapper">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">{{ t('Ad Soyad') }}</th>
              <th scope="col">{{ t('Ünvan') }}</th>
              <th scope="col">{{ t('Kıdem') }}</th>
              <th scope="col">{{ t('Eğitim Yılı') }}</th>
              <th scope="col">{{ t('Minimum Nöbet') }}</th>
              <th scope="col">{{ t('Maksimum Nöbet') }}</th>
              <th scope="col">{{ t('Nöbet Muaf') }}</th>
              <th scope="col">{{ t('İşlemler') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for person in staff %}
              {% set seniority_value = person['seniority'] %}
              <tr>
                <td>{{ person['id'] }}</td>
                <td><strong>{{ person['name'] }}</strong></td>
                <td>{{ t(person['title']) }}</td>
                <td>{{ t(seniority_labels.get(seniority_value, '-')) if seniority_value else '-' }}</td>
                {% set education_year_value = person['education_year'] %}
                {% set education_label = education_year_labels.get(education_year_value) %}
                <td>{{ t(education_label) if education_label else '-' }}</td>
                <td>{{ person["min_night_duties_per_month"] if person["min_night_duties_per_month"] is not none else '-' }}</td>
                <td>{{ person["max_night_duties_per_month"] if person["max_night_duties_per_month"] is not none else '-' }}</td>
                <td>{{ t('Evet') if person['night_duty_exempt'] else t('Hayır') }}</td>
                <td>
                  <div class="opt-table-actions">
                    {% if person["title"] == "Asst. Dr." %}
                      <form method="post" action="{{ url_for('personel') }}" class="opt-table-actions__form">
                        <input type="hidden" name="action" value="update">
                        <input type="hidden" name="staff_id" value="{{ person['id'] }}">
                        <select name="seniority" class="form-select form-select-sm" aria-label="{{ t('Kıdem seçin') }}">
                          {% for value, label in seniority_options %}
                            <option value="{{ value }}" {% if person['seniority'] == value %}selected{% endif %}>{{ t(label) }}</option>
                          {% endfor %}
                        </select>
                        <select name="education_year" class="form-select form-select-sm" aria-label="{{ t('Eğitim yılı') }}">
                          <option value="" {% if person['education_year'] is none %}selected{% endif %}>{{ t('Eğitim yılı yok') }}</option>
                          {% for value, label in education_year_options %}
                            <option value="{{ value }}" {% if person['education_year'] == value %}selected{% endif %}>{{ t(label) }}</option>
                          {% endfor %}
                        </select>
                        <select name="min_night" class="form-select form-select-sm" aria-label="{{ t('Minimum nöbet') }}">
                          <option value="" {% if person['min_night_duties_per_month'] is none %}selected{% endif %}>{{ t('Alt sınır yok') }}</option>
                          {% for value in night_limit_options %}
                            <option value="{{ value }}" {% if person['min_night_duties_per_month'] == value %}selected{% endif %}>{{ value }}</option>
                          {% endfor %}
                        </select>
                        <select name="max_night" class="form-select form-select-sm" aria-label="{{ t('Maksimum nöbet') }}">
                          <option value="" {% if person['max_night_duties_per_month'] is none %}selected{% endif %}>{{ t('Üst sınır yok') }}</option>
                          {% for value in night_limit_options %}
                            <option value="{{ value }}" {% if person['max_night_duties_per_month'] == value %}selected{% endif %}>{{ value }}</option>
                          {% endfor %}
                        </select>
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="night_exempt_{{ person['id'] }}" name="night_duty_exempt" value="1" {% if person['night_duty_exempt'] %}checked{% endif %}>
                          <label class="form-check-label" for="night_exempt_{{ person['id'] }}">{{ t('Nöbet Muaf') }}</label>
                        </div>
                        <button type="submit" class="btn btn-outline-primary btn-sm">{{ t('Kaydet') }}</button>
                      </form>
                    {% endif %}
                    <form method="post" action="{{ url_for('personel') }}">
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="staff_id" value="{{ person['id'] }}">
                      <button type="submit" class="btn btn-outline-danger btn-sm">{{ t('Sil') }}</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="opt-empty-state">
        <p>{{ t('Henüz kayıtlı personel bulunmuyor. Önce ekip arkadaşlarınızı ekleyin.') }}</p>
      </div>
    {% endif %}
  </section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function() {
      var titleSelect = document.getElementById('title');
      var seniorityGroup = document.getElementById('seniority-group');
      var senioritySelect = document.getElementById('seniority');
      var educationGroup = document.getElementById('education-year-group');
      var educationSelect = document.getElementById('education_year');
      var nightExemptRow = document.getElementById('night-exempt-row');
      var nightExemptCheckbox = document.getElementById('night_duty_exempt');
      var nightLimits = document.getElementById('night-limits');
      var minNightInput = document.getElementById('min_night');
      var maxNightInput = document.getElementById('max_night');

      function syncSeniority() {
        var needsSeniority = titleSelect.value === 'Asst. Dr.';
        seniorityGroup.style.display = needsSeniority ? 'block' : 'none';
        educationGroup.style.display = needsSeniority ? 'block' : 'none';
        nightExemptRow.style.display = needsSeniority ? 'flex' : 'none';
        senioritySelect.disabled = !needsSeniority;
        educationSelect.disabled = !needsSeniority;
        nightExemptCheckbox.disabled = !needsSeniority;
        nightLimits.style.display = needsSeniority ? 'grid' : 'none';
        minNightInput.disabled = !needsSeniority;
        maxNightInput.disabled = !needsSeniority;
        if (!needsSeniority) {
          senioritySelect.value = '';
          educationSelect.value = '';
          nightExemptCheckbox.checked = false;
          minNightInput.value = '';
          maxNightInput.value = '';
        }
      }

      titleSelect.addEventListener('change', syncSeniority);
      syncSeniority();
    })();
  </script>
{% endblock %}
