{% extends "layout.html" %}

{% block title %}{{ t('Opti-Shift | Planlama') }}{% endblock %}

{% block page_header %}
  <div class="opt-page-header">
    <div>
      <span class="opt-page-eyebrow">{{ t('Planlama Panosu') }}</span>
      <h1 class="opt-page-title">{{ t('Aylık Görev Planı') }}</h1>
      <p class="opt-page-subtitle">
        {{ t('Klinik şefi olarak ekip mesai ve nöbetlerini dengeli şekilde paylaştırın. Seçili dönem: {month} {year}', month=selected_month_label, year=selected_year) }}
      </p>
    </div>
    <div class="opt-page-actions">
      {% set excel_disabled = error %}
      <a
        href="{{ download_url }}"
        class="btn btn-outline-primary btn-sm {% if excel_disabled %}disabled opt-disabled-link{% endif %}"
        {% if excel_disabled %}aria-disabled="true" tabindex="-1"{% endif %}
      >
        {{ t('Excel İndir') }}
      </a>
    </div>
  </div>
{% endblock %}

{% block content %}
  {% if approval_message %}
    <div class="alert alert-success opt-alert opt-status-banner" role="alert">
      {{ approval_message }}
    </div>
  {% elif approval_error %}
    <div class="alert alert-danger opt-alert opt-status-banner opt-status-banner--error" role="alert">
      {{ approval_error }}
    </div>
  {% endif %}

  <section class="opt-surface-card">
    <header class="opt-toolbar">
      <h2 class="opt-toolbar-title">{{ t('Plan Parametreleri') }}</h2>
    </header>
    {% if error %}
      <div class="alert alert-danger opt-alert" role="alert">{{ error }}</div>
    {% endif %}
    <form method="get" action="{{ url_for('planla') }}" class="opt-form-grid opt-form-grid--cols-2">
      <div class="opt-form-grid__full">
        <label class="form-label">{{ t('Plan Türü') }}</label>
        <div class="opt-segmented-control">
          {% for value, label in plan_type_options %}
            {% set input_id = 'plan-type-' ~ value %}
            <input
              type="radio"
              id="{{ input_id }}"
              name="plan_type"
              value="{{ value }}"
              class="opt-segmented-control__input"
              {% if value == selected_plan_type %}checked{% endif %}
            >
            <label class="opt-segmented-control__item{% if value == selected_plan_type %} is-active{% endif %}" for="{{ input_id }}">
              <span class="opt-segmented-control__label">{{ t(label) }}</span>
            </label>
          {% endfor %}
        </div>
        {% if selected_plan_type == 'nobet' %}
          <p class="opt-plan-note">{{ t('İcap nöbeti uzmanlar arasında sırayla paylaştırılır.') }}</p>
        {% endif %}
      </div>
      <div>
        <label class="form-label" for="year">{{ t('Yıl') }}</label>
        <select id="year" name="year" class="form-select">
          {% for year in year_options %}
            <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="form-label" for="month">{{ t('Ay') }}</label>
        <select id="month" name="month" class="form-select">
          {% for value, label in month_options %}
            <option value="{{ value }}" {% if value == selected_month %}selected{% endif %}>{{ t(label) }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="opt-form-grid__full">
        <div class="opt-floating-actions">
          <button type="submit" class="btn btn-primary btn-lg">{{ t('Plan Oluştur') }}</button>
          {% set excel_disabled = error %}
          <a
            href="{{ download_url }}"
            class="btn btn-outline-primary btn-lg {% if excel_disabled %}disabled opt-disabled-link{% endif %}"
            {% if excel_disabled %}aria-disabled="true" tabindex="-1"{% endif %}
          >
            {{ t('Excel İndir') }}
          </a>
        </div>
      </div>
    </form>
  </section>

  {% if result %}
    <section class="opt-surface-card">
      <header class="opt-toolbar">
        <h2 class="opt-toolbar-title">{{ t('Plan Özeti') }}</h2>
        <span class="opt-pill opt-pill--success">{{ t(result.status_label or 'Hazır') }}</span>
      </header>
      <ul class="opt-summary">
        <li><strong>{{ t('Durum') }}:</strong> {{ t(result.status_label or '-') }}</li>
        <li><strong>{{ t('Hedef') }}:</strong> {{ result.objective_value|round(0) }}</li>
        <li><strong>{{ t('Dönem') }}:</strong> {{ t('{month} {year}', month=selected_month_label, year=selected_year) }}</li>
        <li><strong>{{ t('Plan') }}:</strong> {{ t(selected_plan_type_label) }}</li>
      </ul>
      {% if result.text %}
        <pre class="opt-plan-text">{{ result.text }}</pre>
      {% endif %}
      {% if result.fallback_notes %}
        <div class="alert alert-warning opt-alert mt-3" role="alert">
          {% for note in result.fallback_notes %}
            <div>{{ note }}</div>
          {% endfor %}
        </div>
      {% endif %}
      {% if result.cap_summary %}
        <h3 class="opt-section-title mt-4">{{ t('İcap Nöbeti Dağılımı') }}</h3>
        <div class="opt-table-wrapper">
          <table class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                {% for header in result.cap_summary[0].keys() %}
                  <th>{{ t(header) }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in result.cap_summary %}
                <tr>
                  {% for value in row.values() %}
                    <td>{{ value }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
      {% if result.night_summary %}
        <h3 class="opt-section-title mt-4">{{ t('Gece Nöbeti Dağılımı') }}</h3>
        <div class="opt-table-wrapper">
          <table class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                {% for header in result.night_summary[0].keys() %}
                  <th>{{ t(header) }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in result.night_summary %}
                <tr>
                  {% for value in row.values() %}
                    <td>{{ value }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </section>
  {% endif %}

  {% if result and selected_plan_type == 'clinic' %}
    <section class="opt-surface-card">
      <header class="opt-toolbar">
        <h2 class="opt-toolbar-title">{{ t('Planı Onayla') }}</h2>
      </header>
      <p class="opt-plan-note mb-3">
        {{ t('Onaylanan planın atamaları {period} dönemi için saklanır ve gelecek ayın adalet hesabında kullanılır.', period=plan_period) }}
      </p>
      <form method="post" action="{{ url_for('planla_approve') }}" class="opt-floating-actions">
        <input type="hidden" name="year" value="{{ selected_year }}">
        <input type="hidden" name="month" value="{{ selected_month }}">
        <input type="hidden" name="plan_type" value="{{ selected_plan_type }}">
        <button type="submit" class="btn btn-success btn-lg">{{ t('Planı Onayla ve Kaydet') }}</button>
      </form>
    </section>
  {% endif %}

  {% if plan_table %}
    <section class="opt-surface-card">
      <header class="opt-toolbar">
        <h2 class="opt-toolbar-title">{{ t('Günlük Plan Tablosu') }}</h2>
        <p class="opt-plan-note mb-0">{{ t('Tabloyu Excel olarak dışa aktarmak için üstteki Excel İndir seçeneğini kullanın.') }}</p>
      </header>
      <div class="opt-table-wrapper">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              {% for header in plan_table.headers %}
                <th scope="col">{{ t(header) }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in plan_table.rows %}
              <tr>
                {% for header in plan_table.headers %}
                  <td>{{ row[header] }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  {% endif %}
{% endblock %}
