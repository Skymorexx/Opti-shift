{% extends "layout.html" %}

{% block title %}Opti-shift | Nobet Turleri{% endblock %}

{% block page_header %}
  <div class="opt-page-header">
    <div>
      <span class="opt-page-eyebrow">Gorev Tipleri</span>
      <h1 class="opt-page-title">Nobet Turleri</h1>
      <p class="opt-page-subtitle">
        Nobet ve mesa gorev tanimlarini olusturun, planlama motorunun gereksinimlerini belirleyin.
      </p>
    </div>
    <div class="opt-page-actions">
      <span class="opt-page-meta">Toplam nobet turu: {{ duty_types|length }}</span>
    </div>
  </div>
{% endblock %}

{% block content %}
  <section class="opt-surface-card">
    <header class="opt-toolbar">
      <h2 class="opt-toolbar-title">Yeni Nobet Turu</h2>
    </header>
    {% if error %}
      <div class="alert alert-danger opt-alert" role="alert">{{ error }}</div>
    {% endif %}
    <form method="post" action="{{ url_for('nobetler') }}" class="opt-form-grid opt-form-grid--cols-2" id="duty-type-form">
      <input type="hidden" name="action" value="add">
      <div>
        <label class="form-label" for="name">Nobet Adi</label>
        <input type="text" id="name" name="name" class="form-control" placeholder="Orn: Gece Nobeti" required>
      </div>
      <div>
        <label class="form-label" for="duration_hours">Sure (saat)</label>
        <input type="number" id="duration_hours" name="duration_hours" class="form-control" min="1" step="1" placeholder="Orn: 16" required>
      </div>
      <div>
        <label class="form-label" for="duty_category">Kategori</label>
        <select id="duty_category" name="duty_category" class="form-select" required>
          <option value="mesa">Mesa</option>
          <option value="nobet" selected>Nobet</option>
        </select>
      </div>
      <div>
        <label class="form-label" for="required_staff_count">Gerekli Personel</label>
        <input type="number" id="required_staff_count" name="required_staff_count" class="form-control" min="1" value="1" required>
      </div>
      <div class="opt-form-grid__full">
        <div class="form-check form-switch opt-form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="is_cap" name="is_cap" value="1">
          <label class="form-check-label" for="is_cap">Bu gorev icin cap (icap) kalibini kullan</label>
        </div>
      </div>
      <div class="opt-form-grid__full">
        <div class="opt-floating-actions">
          <button type="submit" class="btn btn-primary btn-lg">Nobet Turu Ekle</button>
        </div>
      </div>
    </form>
  </section>

  <section class="opt-surface-card">
    <header class="opt-toolbar">
      <h2 class="opt-toolbar-title">Kayitli Nobet Turleri</h2>
      {% if duty_types %}
        <span class="opt-meta">{{ duty_types|length }} kayit</span>
      {% endif %}
    </header>
    {% if duty_types %}
      <div class="opt-table-wrapper">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Ad</th>
              <th scope="col">Sure (saat)</th>
              <th scope="col">Kategori</th>
              <th scope="col">Gerekli Personel</th>
            </tr>
          </thead>
          <tbody>
            {% for duty in duty_types %}
              {% set category = (duty['duty_category'] or 'nobet') | lower %}
              <tr>
                <td>{{ duty["id"] }}</td>
                <td>{{ duty["name"] }}</td>
                <td>{{ duty["duration_hours"] }}</td>
                <td>
                  <span class="opt-badge opt-badge--{{ category }}">{{ category }}</span>
                </td>
                <td>{{ duty['required_staff_count'] or 1 }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="opt-empty-state">
        <p>Henuz nobet turu eklenmedi.</p>
      </div>
    {% endif %}
  </section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function() {
      var capToggle = document.getElementById('is_cap');
      var nameInput = document.getElementById('name');
      var durationInput = document.getElementById('duration_hours');
      var categorySelect = document.getElementById('duty_category');
      var requiredInput = document.getElementById('required_staff_count');

      function syncCapFields() {
        var isCap = capToggle.checked;
        if (isCap) {
          nameInput.value = 'cap';
          nameInput.readOnly = true;
          durationInput.value = 24;
          durationInput.readOnly = true;
          categorySelect.value = 'nobet';
          categorySelect.disabled = true;
          requiredInput.value = 1;
          requiredInput.readOnly = true;
        } else {
          nameInput.readOnly = false;
          durationInput.readOnly = false;
          categorySelect.disabled = false;
          requiredInput.readOnly = false;
        }
      }

      capToggle.addEventListener('change', syncCapFields);
      syncCapFields();
    })();
  </script>
{% endblock %}
