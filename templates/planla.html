{% extends "layout.html" %}

{% block title %}Opti-shift | Planlama{% endblock %}

{% block page_header %}
  <div class="opt-page-header">
    <div>
      <span class="opt-page-eyebrow">Planlama Panosu</span>
      <h1 class="opt-page-title">Aylik Gorev Plani</h1>
      <p class="opt-page-subtitle">
        Klinik sefi olarak ekip mesai ve nobetlerini dengeli sekilde paylastirin. Secili donem: {{ selected_month_label }} {{ selected_year }}.
      </p>
    </div>
    <div class="opt-page-actions">
      {% set excel_disabled = error %}
      <a
        href="{{ download_url }}"
        class="btn btn-outline-primary btn-sm {% if excel_disabled %}disabled opt-disabled-link{% endif %}"
        {% if excel_disabled %}aria-disabled="true" tabindex="-1"{% endif %}
      >
        Excel Indir
      </a>
    </div>
  </div>
{% endblock %}

{% block content %}
  {% if approval_message %}
    <div class="alert alert-success opt-alert opt-status-banner" role="alert">
      {{ approval_message }}
    </div>
  {% elif approval_error %}
    <div class="alert alert-danger opt-alert opt-status-banner opt-status-banner--error" role="alert">
      {{ approval_error }}
    </div>
  {% endif %}

  <section class="opt-surface-card">
    <header class="opt-toolbar">
      <h2 class="opt-toolbar-title">Plan Parametreleri</h2>
    </header>
    {% if error %}
      <div class="alert alert-danger opt-alert" role="alert">{{ error }}</div>
    {% endif %}
    <form method="get" action="{{ url_for('planla') }}" class="opt-form-grid opt-form-grid--cols-2">
      <div class="opt-form-grid__full">
        <label class="form-label">Plan Turu</label>
        <div class="opt-segmented-control">
          {% for value, label in plan_type_options %}
            {% set input_id = 'plan-type-' ~ value %}
            <input
              type="radio"
              id="{{ input_id }}"
              name="plan_type"
              value="{{ value }}"
              class="opt-segmented-control__input"
              {% if value == selected_plan_type %}checked{% endif %}
            >
            <label class="opt-segmented-control__item{% if value == selected_plan_type %} is-active{% endif %}" for="{{ input_id }}">
              <span class="opt-segmented-control__label">{{ label }}</span>
              {% if value != 'clinic' %}
                <span class="opt-pill opt-pill--upcoming">Yakinda</span>
              {% endif %}
            </label>
          {% endfor %}
        </div>
        {% if selected_plan_type == 'nobet' %}
          <p class="opt-plan-note">Cap nobeti uzmanlar arasinda sirayla pay edilir.</p>
        {% endif %}
      </div>
      <div>
        <label class="form-label" for="year">Yil</label>
        <select id="year" name="year" class="form-select">
          {% for year in year_options %}
            <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="form-label" for="month">Ay</label>
        <select id="month" name="month" class="form-select">
          {% for value, label in month_options %}
            <option value="{{ value }}" {% if value == selected_month %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="opt-form-grid__full">
        <div class="opt-floating-actions">
          <button type="submit" class="btn btn-primary btn-lg">Plan Olustur</button>
          {% set excel_disabled = error %}
          <a
            href="{{ download_url }}"
            class="btn btn-outline-primary btn-lg {% if excel_disabled %}disabled opt-disabled-link{% endif %}"
            {% if excel_disabled %}aria-disabled="true" tabindex="-1"{% endif %}
          >
            Excel Indir
          </a>
        </div>
      </div>
    </form>
  </section>

  {% if result %}
    <section class="opt-surface-card">
      <header class="opt-toolbar">
        <h2 class="opt-toolbar-title">Plan Ozet</h2>
        <span class="opt-pill opt-pill--success">{{ result.status_label or 'Hazir' }}</span>
      </header>
      <ul class="opt-summary">
        <li><strong>Durum:</strong> {{ result.status_label or '-' }}</li>
        <li><strong>Hedef:</strong> {{ result.objective_value|round(0) }}</li>
        <li><strong>Donem:</strong> {{ selected_month_label }} {{ selected_year }}</li>
        <li><strong>Plan:</strong> {{ selected_plan_type_label }}</li>
      </ul>
      {% if result.text %}
        <pre class="opt-plan-text">{{ result.text }}</pre>
      {% endif %}
      {% if result.fallback_notes %}
        <div class="alert alert-warning opt-alert mt-3" role="alert">
          {% for note in result.fallback_notes %}
            <div>{{ note }}</div>
          {% endfor %}
        </div>
      {% endif %}
      {% if result.cap_summary %}
        <h3 class="opt-section-title mt-4">Cap Nobeti Dagilimi</h3>
        <div class="opt-table-wrapper">
          <table class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                {% for header in result.cap_summary[0].keys() %}
                  <th>{{ header }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in result.cap_summary %}
                <tr>
                  {% for value in row.values() %}
                    <td>{{ value }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
      {% if result.night_summary %}
        <h3 class="opt-section-title mt-4">Gece Nobeti Dagilimi</h3>
        <div class="opt-table-wrapper">
          <table class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                {% for header in result.night_summary[0].keys() %}
                  <th>{{ header }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in result.night_summary %}
                <tr>
                  {% for value in row.values() %}
                    <td>{{ value }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </section>
  {% endif %}

  {% if result and selected_plan_type == 'clinic' %}
    <section class="opt-surface-card">
      <header class="opt-toolbar">
        <h2 class="opt-toolbar-title">Plani Onayla</h2>
      </header>
      <p class="opt-plan-note mb-3">
        Onaylanan planin atamalari {{ plan_period }} donemi icin saklanir ve gelecek ayin adalet hesabinda kullanilir.
      </p>
      <form method="post" action="{{ url_for('planla_approve') }}" class="opt-floating-actions">
        <input type="hidden" name="year" value="{{ selected_year }}">
        <input type="hidden" name="month" value="{{ selected_month }}">
        <input type="hidden" name="plan_type" value="{{ selected_plan_type }}">
        <button type="submit" class="btn btn-success btn-lg">Plani Onayla ve Kaydet</button>
      </form>
    </section>
  {% endif %}

  {% if plan_table %}
    <section class="opt-surface-card">
      <header class="opt-toolbar">
        <h2 class="opt-toolbar-title">Gunluk Plan Tablosu</h2>
        <p class="opt-plan-note mb-0">Tabloyu Excel olarak paylasmak icin Excel Indir secenegini kullanabilirsiniz.</p>
      </header>
      <div class="opt-table-wrapper">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              {% for header in plan_table.headers %}
                <th scope="col">{{ header }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in plan_table.rows %}
              <tr>
                {% for header in plan_table.headers %}
                  <td>{{ row[header] }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  {% endif %}
{% endblock %}
